/*
Copyright (c) 2013 Dave Leeds
License: https://raw.github.com/djleeds/code-callout/master/LICENSE.md
*/
!function(a,b){"use strict";a.fn.codeCallout=function(r){function s(a){var b=new m("code-callout-note","content",a.closeButtonText,"close"),c=new n,d=new o(new j,a.getLineSelector,"code-callout-highlighted"),e=new h(a.scrollTargetSelector,a.animationDurationInMs);return new l(b,c,d,e,a.noteOffsetFromLine)}function t(){var b=0;return a(v.scrollTargetSelector).each(function(c,d){var e=a(d).scrollTop();b=e>b?e:b}),b}var u=new d,v=a.extend(p,r),w=new i(v.styleId,q),x=new k(v.listingIdAttribute,v.lineNumbersAttribute,v.noteContentsAttribute),y=s(v);return w.initialize(),a(this).attr("href","#").on(v.triggerEventName,function(a){a.preventDefault(),u.deactivate(),u=y.create(x.read(this),t()),u.activate()}),v.exposeForTest&&(b.__codeCallout={Callout:c,NullCallout:d,Note:e,Listing:f,LineSet:g,Scroller:h,Style:i,LineNumberParser:j,TriggerReader:k,CalloutFactory:l,NoteFactory:m,ListingFactory:n,LineSetFactory:o}),this};var c=function(a,b,c,d,e,f){var g=this;a.onClose(function(){g.deactivate()}),this.activate=function(){a.activate(),c.highlight(),d.to(g.position())},this.deactivate=function(){a.deactivate(),c.unhighlight(),d.to(e)},this.center=function(){return(c.top()+a.bottom())/2},this.positionCalculator={windowHeight:f.innerHeight,scrollTop:function(){return this.scrollCenter()-this.windowHeight/2},overhang:function(){return Math.max(a.bottom()-b.bottom(),0)},leash:function(){return Math.max(b.height()-this.windowHeight,0)/2},distance:function(){return g.center()-b.center()},clampedDistance:function(){var a=this.leash();return Math.max(Math.min(this.distance(),a+this.overhang()),-a)},scrollCenter:function(){return b.center()+this.clampedDistance()}},this.position=function(){return this.positionCalculator.scrollTop()}},d=function(){this.deactivate=function(){}},e=function(b,c,d){var e="resize.code-callout-note",f=function(){};this.activate=function(){this.attach(),this.positionAt(c()),this.hook(),this.show()},this.deactivate=function(){this.hide(),this.unhook(),this.detach()},this.attach=function(){b.appendTo(a("body"))},this.detach=function(){b.remove()},this.show=function(){b.show()},this.hide=function(){b.hide()},this.hook=function(){d.on(e,function(){this.position(c())}),b.find("button.close").on("click",function(){f()})},this.unhook=function(){d.off(e)},this.bottom=function(){return b.offset().top+b.outerHeight()},this.positionAt=function(a){b.css(a)},this.onClose=function(a){f=a}},f=function(a){this.top=function(){return a.offset().top},this.bottom=function(){return this.top()+this.height()},this.height=function(){return a.outerHeight()},this.center=function(){return(this.top()+this.bottom())/2}},g=function(a,b){this.highlight=function(){a.addClass(b)},this.unhighlight=function(){a.removeClass(b)},this.top=function(){return a.first().offset().top},this.bottom=function(){return a.last().offset().top+this.lineHeight()},this.left=function(){return a.last().offset().left},this.lineHeight=function(){return a.last().outerHeight()}},h=function(b,c){this.to=function(a){this.selectElement().stop().animate({scrollTop:a},c)},this.selectElement=function(){return a(b)}},i=function(b,c){this.initialize=function(){this.hasBeenWritten()||this.write()},this.hasBeenWritten=function(){return a("#"+b).length>0},this.write=function(){a("<style />").attr("type","text/css").attr("id",b).text(this.build()).appendTo(a("body"))},this.build=function(){var a="";for(var b in c){a+=b+"{";for(var d in c[b])a+=d+":"+c[b][d]+";";a+="} "}return a}},j=function(){this.parse=function(a){if(!isNaN(a))return[Number(a)];for(var b=[],c=a.split(","),d=0;d<c.length;d++){var e=c[d];this.isLineRange(e)?b=b.concat(this.parseLineRange(e)):b.push(Number(e))}return b},this.isLineRange=function(a){return a.indexOf("-")>0},this.parseLineRange=function(a){for(var b=[],c=a.split("-"),d=c[0],e=c[1],f=d;e>=f;f++)b.push(Number(f));return b}},k=function(b,c,d){this.read=function(e){var f=a(e);return{listingId:f.data(b),lineNumbers:f.data(c),noteContents:f.data(d)}}},l=function(a,d,e,f,g){this.create=function(g,h){var i=d.create(g.listingId),j=e.create(g.listingId,g.lineNumbers),k=this.createPositionAdvice(j),l=a.create(g.noteContents,k);return new c(l,i,j,f,h,b)},this.createPositionAdvice=function(a){return function(){return{top:a.bottom()+a.lineHeight()*g,left:a.left()}}}},m=function(c,d,f,g){this.renderContent=function(b){return a("<div />").addClass(d).text(b)},this.renderCloseButton=function(){return a("<button />").addClass(g).text(f)},this.render=function(b){var d=this.renderContent(b),e=this.renderCloseButton(f);return a("<div />").attr("id",c).append(d).append(e)},this.create=function(c,d){var g=this.render(c,f);return new e(g,d,a(b))}},n=function(){this.create=function(a){return new f(this.selectElement(a))},this.selectElement=function(b){return a("#"+b)}},o=function(b,c,d){this.create=function(a,c){var e=b.parse(c),f=this.selectLines(a,e);return new g(f,d)},this.selectLines=function(b,d){var e=a();return a.each(d,function(d,f){e=e.add(a(c(b,f)))}),e}},p={animationDurationInMs:500,closeButtonText:"Continue reading",scrollTargetSelector:"html,body",triggerEventName:"click",listingIdAttribute:"listing",lineNumbersAttribute:"lines",noteContentsAttribute:"note",getLineSelector:function(a,b){return"#"+a+" .line-data .line:nth-child("+b+")"},styleId:"code-callout-styles",noteOffsetFromLine:.25,exposeForTest:!1},q={".code-callout-highlighted":{"background-color":"#FFA"},"#code-callout-note":{position:"absolute","background-color":"#EAEAEA",background:"linear-gradient(to bottom, white 0%, #EAEAEA 100%)","border-radius":"1em",padding:"1em 1em 3em 1em",border:"1px solid #CCC","box-shadow":"0.25em 0.25em 0.5em #CCC","min-width":"7em"},"#code-callout-note button.close":{"font-size":"75%",position:"absolute",bottom:"0",right:"0",margin:"1.5em","white-space":"nowrap"}}}(jQuery,window);