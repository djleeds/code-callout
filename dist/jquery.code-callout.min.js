/*
Copyright (c) 2013-2014 Dave Leeds
License: https://raw.github.com/djleeds/code-callout/master/LICENSE.md
*/
!function(a,b){"use strict";a.fn.codeCallout=function(t){function u(a){var b=new n("code-callout-note","content",a.closeButtonText,"close"),c=new o,d=new p(new j,a.getLineSelector,"code-callout-highlighted"),e=new h(a.scrollTargetSelector,a.animationDurationInMs);return new m(b,c,d,e,a.noteOffsetFromLine)}function v(){var b=0;return a(x.scrollTargetSelector).each(function(c,d){var e=a(d).scrollTop();b=e>b?e:b}),b}var w=new d,x=a.extend(q,t),y=r;if(x.profile in s==!1)throw"Unrecognized profile "+x.profile+" was requested.";var z=s[x.profile];"options"in z&&(x=a.extend(x,z.options)),"styles"in z&&(y=a.extend(y,z.styles));var A=new i(x.styleId,y),B=new k(x.listingIdAttribute,x.lineNumbersAttribute,x.noteContentsAttribute),C=u(x);return A.initialize(),a(this).attr("href","#").on(x.triggerEventName,function(b){var c=B.read(this);if(console.log("wrapping",c.listingId,x),x.shouldWrapLines){var d=new l(a("#"+c.listingId+" "+x.lineWrapContainerSubselector),x.wrapperLineClass,x.wrapperNumberClassPrefix,x.filterLinesToWrap,x.beforeLinesOfCodeAreWrapped);d.wrapListing()}b.preventDefault(),w.deactivate(),w=C.create(c,v()),w.activate()}),x.exposeForTest&&(b.__codeCallout={Callout:c,NullCallout:d,Note:e,Listing:f,LineSet:g,Scroller:h,Style:i,LineNumberParser:j,TriggerReader:k,LineWrapper:l,CalloutFactory:m,NoteFactory:n,ListingFactory:o,LineSetFactory:p,options:x}),this};var c=function(a,b,c,d,e,f){var g=this;a.onClose(function(){g.deactivate()}),this.activate=function(){a.activate(),c.highlight(),d.to(g.position())},this.deactivate=function(){a.deactivate(),c.unhighlight(),d.to(e)},this.center=function(){return(c.top()+a.bottom())/2},this.positionCalculator={windowHeight:f.innerHeight,scrollTop:function(){return this.scrollCenter()-this.windowHeight/2},overhang:function(){return Math.max(a.bottom()-b.bottom(),0)},leash:function(){return Math.max(b.height()-this.windowHeight,0)/2},distance:function(){return g.center()-b.center()},clampedDistance:function(){var a=this.leash();return Math.max(Math.min(this.distance(),a+this.overhang()),-a)},scrollCenter:function(){return b.center()+this.clampedDistance()}},this.position=function(){return this.positionCalculator.scrollTop()}},d=function(){this.deactivate=function(){}},e=function(b,c,d){var e="resize.code-callout-note",f=function(){};this.activate=function(){this.attach(),this.positionAt(c()),this.hook(),this.show()},this.deactivate=function(){this.hide(),this.unhook(),this.detach()},this.attach=function(){b.appendTo(a("body"))},this.detach=function(){b.remove()},this.show=function(){b.show()},this.hide=function(){b.hide()},this.hook=function(){d.on(e,function(){this.position(c())}),b.find("button.close").on("click",function(){f()})},this.unhook=function(){d.off(e)},this.bottom=function(){return b.offset().top+b.outerHeight()},this.positionAt=function(a){b.css(a)},this.onClose=function(a){f=a}},f=function(a){this.top=function(){return a.offset().top},this.bottom=function(){return this.top()+this.height()},this.height=function(){return a.outerHeight()},this.center=function(){return(this.top()+this.bottom())/2}},g=function(a,b){this.highlight=function(){a.addClass(b)},this.unhighlight=function(){a.removeClass(b)},this.top=function(){return a.first().offset().top},this.bottom=function(){return a.last().offset().top+this.lineHeight()},this.left=function(){return a.last().offset().left},this.lineHeight=function(){return a.last().outerHeight()}},h=function(b,c){this.to=function(a){this.selectElement().stop().animate({scrollTop:a},c)},this.selectElement=function(){return a(b)}},i=function(b,c){this.initialize=function(){this.hasBeenWritten()||this.write()},this.hasBeenWritten=function(){return a("#"+b).length>0},this.write=function(){a("<style />").attr("type","text/css").attr("id",b).text(this.build()).appendTo(a("body"))},this.build=function(){var a="";for(var b in c){a+=b+"{";for(var d in c[b])a+=d+":"+c[b][d]+";";a+="} "}return a}},j=function(){this.parse=function(a){if(!isNaN(a))return[Number(a)];for(var b=[],c=a.split(","),d=0;d<c.length;d++){var e=c[d];this.isLineRange(e)?b=b.concat(this.parseLineRange(e)):b.push(Number(e))}return b},this.isLineRange=function(a){return a.indexOf("-")>0},this.parseLineRange=function(a){for(var b=[],c=a.split("-"),d=c[0],e=c[1],f=d;e>=f;f++)b.push(Number(f));return b}},k=function(b,c,d){this.read=function(e){var f=a(e);return{listingId:f.data(b),lineNumbers:f.data(c),noteContents:f.data(d)}}},l=function(b,c,d,e,f){var g=this,h="\n";this.isAlreadyWrapped=function(){return b.find("."+c).length>0},this.wrapLine=function(b,e){var f=b+1;return a("<div />").addClass(c).addClass(d+f).html(e+h)},this.splitIntoLines=function(){return e(b).html().split(h)},this.replaceListing=function(a){b.html(a.children("*"))},this.wrapListing=function(){if(!this.isAlreadyWrapped()){var c=this.splitIntoLines(b),d=a("<div />");a.each(c,function(a,b){d.append(g.wrapLine(a,b))}),f(b,d),this.replaceListing(d)}}},m=function(a,d,e,f,g){this.create=function(g,h){var i=d.create(g.listingId),j=e.create(g.listingId,g.lineNumbers),k=this.createPositionAdvice(j),l=a.create(g.noteContents,k);return new c(l,i,j,f,h,b)},this.createPositionAdvice=function(a){return function(){return{top:a.bottom()+a.lineHeight()*g,left:a.left()}}}},n=function(c,d,f,g){this.renderContent=function(b){return a("<div />").addClass(d).text(b)},this.renderCloseButton=function(){return a("<button />").addClass(g).text(f)},this.render=function(b){var d=this.renderContent(b),e=this.renderCloseButton(f);return a("<div />").attr("id",c).append(d).append(e)},this.create=function(c,d){var g=this.render(c,f);return new e(g,d,a(b))}},o=function(){this.create=function(a){return new f(this.selectElement(a))},this.selectElement=function(b){return a("#"+b)}},p=function(b,c,d){this.create=function(a,c){var e=b.parse(c),f=this.selectLines(a,e);return new g(f,d)},this.selectLines=function(b,d){var e=a();return a.each(d,function(d,f){e=e.add(a(c(b,f)))}),e}},q={profile:"pre",animationDurationInMs:500,closeButtonText:"Continue reading",scrollTargetSelector:"html,body",triggerEventName:"click",listingIdAttribute:"listing",lineNumbersAttribute:"lines",noteContentsAttribute:"note",styleId:"code-callout-styles",noteOffsetFromLine:.25,exposeForTest:!1,shouldWrapLines:!1,wrapperLineClass:"code-callout-line",wrapperNumberClassPrefix:"number-",lineWrapContainerSubselector:"",getLineSelector:function(){throw"Not Implemented"},filterLinesToWrap:function(a){return a},beforeLinesOfCodeAreWrapped:function(a,b){return b}},r={".code-callout-line":{width:"100%"},".code-callout-highlighted":{"background-color":"#FFA"},"#code-callout-note":{position:"absolute","background-color":"#EAEAEA",background:"linear-gradient(to bottom, white 0%, #EAEAEA 100%)","border-radius":"1em",padding:"1em 1em 3em 1em",border:"1px solid #CCC","box-shadow":"0.25em 0.25em 0.5em #CCC","min-width":"7em"},"#code-callout-note button.close":{"font-size":"75%",position:"absolute",bottom:"0",right:"0",margin:"1.5em","white-space":"nowrap"}},s={gist:{options:{getLineSelector:function(a,b){return"#"+a+" .line-data .line:nth-child("+b+")"}}},"jquery-syntax":{options:{getLineSelector:function(a,b){return"#"+a+" .ln"+b}}},pre:{options:{shouldWrapLines:!0,getLineSelector:function(a,b){return"#"+a+" .code-callout-line.number-"+b}}},prism:{options:{shouldWrapLines:!0,lineWrapContainerSubselector:"code",getLineSelector:function(a,b){return"#"+a+" .code-callout-line.number-"+b},filterLinesToWrap:function(a){return a.not(".line-numbers-rows")},beforeLinesOfCodeAreWrapped:function(a,b){return b.append(a.find(".line-numbers-rows"))}}},syntaxhighlighter:{options:{getLineSelector:function(a,b){return"#"+a+" .line.number"+b}},styles:{"div.syntaxhighlighter div.container div.code-callout-highlighted":{"background-color":r[".code-callout-highlighted"]["background-color"]+" !important"}}}}}(jQuery,window);